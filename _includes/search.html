<!-- Pagefind Search Modal -->
<div id="search-modal" class="search-modal" role="dialog" aria-modal="true" aria-labelledby="search-title">
  <div class="search-modal-backdrop"></div>
  <div class="search-modal-content">
    <div class="search-modal-header">
      <span id="search-title" class="visually-hidden">Search documentation</span>
      <div id="search-container"></div>
      <button class="search-close" aria-label="Close search">&times;</button>
    </div>
  </div>
</div>

<!-- Search trigger button in header -->
<button class="search-trigger" aria-label="Search (Cmd+K)">
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle>
    <path d="m21 21-4.3-4.3"></path>
  </svg>
  <span class="search-trigger-text">Search</span>
  <kbd class="search-shortcut"><span>&#8984;</span>K</kbd>
</button>

<link href="{{ '/_pagefind/pagefind-ui.css' | relative_url }}" rel="stylesheet">
<script src="{{ '/_pagefind/pagefind-ui.js' | relative_url }}" defer></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('search-modal');
  const backdrop = modal.querySelector('.search-modal-backdrop');
  const closeBtn = modal.querySelector('.search-close');
  const triggers = document.querySelectorAll('.search-trigger');

  // Initialize Pagefind when modal first opens
  let pagefindInitialized = false;

  function openSearch() {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    if (!pagefindInitialized && typeof PagefindUI !== 'undefined') {
      new PagefindUI({
        element: "#search-container",
        showSubResults: true,
        showImages: false,
        placeholder: "Search documentation...",
        autofocus: true
      });
      pagefindInitialized = true;
    }

    // Focus the search input
    setTimeout(() => {
      const input = modal.querySelector('.pagefind-ui__search-input');
      if (input) input.focus();
    }, 100);
  }

  function closeSearch() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
  }

  // Event listeners
  triggers.forEach(trigger => {
    trigger.addEventListener('click', openSearch);
  });

  closeBtn.addEventListener('click', closeSearch);
  backdrop.addEventListener('click', closeSearch);

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Cmd+K or Ctrl+K to open
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      openSearch();
    }
    // Escape to close
    if (e.key === 'Escape' && modal.classList.contains('active')) {
      closeSearch();
    }
  });
});
</script>
